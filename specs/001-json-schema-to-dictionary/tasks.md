# Tasks: JSON Schema to Dictionary

**Input**: Design documents from `/specs/001-json-schema-to-dictionary/`
**Prerequisites**: plan.md, spec.md, data-model.md, research.md, quickstart.md

**Tests**: Testing scope is limited to utility functions as easily testable as `getAllExceptMd`. Functions with complex environmental dependencies (e.g., `fs` writes, `Worker` interactions) will not be covered by new dedicated tests in this phase.

**Organization**: All tasks are part of a single user story for this refactoring effort.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1)
- Include exact file paths in descriptions

## Path Conventions

- **Single project**: `src/`, `tests/` at repository root

---

## Phase 1: Foundational (Blocking Prerequisites)

**Purpose**: Review core data structures and ensure the basic test is updated.

- [X] T001 [P] Review the existing implementation of the four JSON export functions in `src/methods.ts`.
- [X] T002 [P] Review `src/workers/metadata.worker.ts` to understand the backlink generation logic.
- [X] T003 Update the type definitions in `src/interfaces.ts` if necessary.

### Test Setup

- [X] T004 Update the existing `getAllExceptMd` test in `tests/methods.test.ts` to expect dictionary output and verify against snapshot.

---

## Phase 2: User Story 1 - Efficient Metadata Lookup (Priority: P1) ðŸŽ¯ MVP

**Goal**: Refactor all four JSON exports to use a dictionary schema instead of an array.

**Independent Test**: The `getAllExceptMd` test will verify the basic dictionary transformation. Output of `write...` functions will be manually inspected.

### Implementation Tasks

- [X] T005 Modify the `getAll` function in `src/methods.ts` to check `children` or `extension` instead of `instanceof` for robustness with mock objects.
- [X] T006 Modify the `writeCanvases` function in `src/methods.ts` to build a dictionary and update its `instanceof` check.
- [X] T007 Modify the `writeAllExceptMd` function in `src/methods.ts` to build a dictionary and update `src/utils.ts` to reflect the new return type.
- [X] T008 Modify the `writeTagsToJSON` function in `src/methods.ts` to build a dictionary for `tags.json` keyed by tag name.
- [X] T009 Modify the `writeCacheToJSON` function in `src/methods.ts` to build a dictionary for `metadata.json` keyed by `relativePath` and fix the `Worker()` call to `new Worker()`.
- [X] T010 Update `src/workers/metadata.worker.ts` to process the dictionary data structure for backlink calculation.

---

## Phase 3: Polish & Cross-Cutting Concerns

**Purpose**: Final documentation and cleanup.

- [X] T011 [P] Update the `README.md` to document the new JSON schema for all four exports, including code examples.
- [X] T012 Run `npm test` to ensure the `getAllExceptMd` test passes after all changes.
- [X] T013 [P] Manually inspect the output JSON files generated by the plugin to confirm correct schema transformation.

---

## Dependencies & Execution Order

### Phase Dependencies

- **Foundational (Phase 1)**: Can start immediately. Test Setup tasks (T004) should be completed before Implementation Tasks in Phase 2.
- **User Story 1 (Phase 2)**: Depends on Foundational phase completion.
- **Polish (Phase 3)**: Depends on User Story 1 completion.

### Within User Story 1

- Implementation Tasks (T005-T010) can be tackled in any order.

## Implementation Strategy

### MVP First (User Story 1 Only)

1.  Complete Phase 1: Foundational (including Test Setup).
2.  Complete Phase 2: User Story 1 (all Implementation tasks).
3.  Complete Phase 3: Polish.
4.  **STOP and VALIDATE**: Manually inspect the generated JSON files and run the `getAllExceptMd` test to confirm the new schema is correct and basic data transformation is valid.